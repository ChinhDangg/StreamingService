
Enable universe (Ubuntu only):
sudo add-apt-repository universe
sudo apt update

Install ZFS:
sudo apt install -y zfsutils-linux

Check drives:
lsblk
lsblk -o NAME,SIZE,TYPE,MOUNTPOINT

# Check which filesystem backs
df -h /media/file_pool
df -h /media/media_pool

Clearing drives: sudo wipefs -a /dev/nvme2n1
sudo wipefs -a /dev/nvme3n1 -- use carefully

sudo sgdisk --zap-all /dev/nvme2n1 -- use carefully
sudo sgdisk --zap-all /dev/nvme3n1 -- use carefully

# Verify pool status: zpool status
zfs list
zpool list

# Check zpool detailed stats
zpool iostat -v media_pool

# Checking pending pool to be imported:
sudo zpool import

# Importing the pool:
sudo zpool import -f media_pool


# Creating media_pool:
sudo zpool create media_pool \
  /dev/nvme2n1 \
  /dev/nvme3n1

# Set the mountpoint:
sudo zfs set mountpoint=/media/media_pool media_pool

# Set ownership (for Docker / services):
sudo chown -R chinh:chinh /media/media_pool

# ZFS tuning for media workloads:
sudo zfs set recordsize=1M media_pool
sudo zfs set compression=lz4 media_pool
sudo zfs set atime=off media_pool
sudo zfs set primarycache=metadata media_pool
sudo zfs set xattr=sa media_pool/data
sudo zfs set acltype=posixacl media_pool/data
sudo zfs set aclinherit=passthrough media_pool/data

# See drive settings
zfs get recordsize,compression,atime,logbias,primarycache,xattr media_pool/data



# Creating file_pool:
sudo zpool create file_pool \
  /dev/nvme4n1 \
  /dev/nvme0n1

# Creating ZFS datasets for file_pool:
sudo zfs create file_pool/files
sudo zfs create file_pool/postgres
sudo zfs create file_pool/opensearch

# Set the parent mount point
sudo zfs set mountpoint=/media/file_pool file_pool

# Set the individual datasets’ mount points explicitly
sudo zfs set mountpoint=/media/file_pool/files file_pool/files
sudo zfs set mountpoint=/media/file_pool/postgres file_pool/postgres
sudo zfs set mountpoint=/media/file_pool/opensearch file_pool/opensearch

# PostgreSQL dataset tuning:
sudo zfs set recordsize=16K file_pool/postgres
sudo zfs set compression=lz4 file_pool/postgres
sudo zfs set atime=off file_pool/postgres
sudo zfs set logbias=latency file_pool/postgres
sudo zfs set xattr=sa file_pool/postgres

# OpenSearch dataset tuning:
sudo zfs set recordsize=128K file_pool/opensearch
sudo zfs set compression=lz4 file_pool/opensearch
sudo zfs set atime=off file_pool/opensearch
sudo zfs set primarycache=metadata file_pool/opensearch
sudo zfs set xattr=sa file_pool/opensearch

# Files dataset tuning:
sudo zfs set recordsize=1M file_pool/files
sudo zfs set compression=lz4 file_pool/files
sudo zfs set atime=off file_pool/files
sudo zfs set xattr=sa file_pool/files

# See drive settings:
zfs get recordsize,compression,atime,logbias,primarycache,xattr file_pool/files file_pool/postgres file_pool/opensearch


# Installing Docker:
sudo apt update
sudo apt install -y docker.io

# Enable Docker to start at boot:
sudo systemctl enable docker
sudo systemctl start docker
Add your user to the docker group

# Add your user to the docker group (This is required to run Docker without sudo):
sudo usermod -aG docker $USER


# Set ownership problem:
# Set file_pool to root:
sudo chmod 755 /media/file_pool
sudo chown root:root /media/file_pool

# Set each direct path to correct user id. (1000 is $USER chinh):
sudo chown root:root /media/file_pool

sudo chown -R chinh:chinh /media/file_pool/files
sudo chmod -R 755 /media/file_pool/files

sudo chown -R chinh:chinh /media/file_pool/opensearch
sudo chmod -R 755 /media/file_pool/opensearch

sudo chown -R 999:999 /media/file_pool/postgres
sudo chmod -R 700 /media/file_pool/postgres

# For remounting:
# Unmounting the children first
sudo zfs unmount file_pool/files
sudo zfs unmount file_pool/postgres
sudo zfs unmount file_pool/opensearch

# Unmounting the parent second
sudo zfs unmount file_pool
# Set the new mounting point
sudo zfs set mountpoint=/media/file_pool file_pool

# Tell the child datasets to "inherit" the new mountpoint from their parent
sudo zfs inherit mountpoint file_pool/files
sudo zfs inherit mountpoint file_pool/postgres
sudo zfs inherit mountpoint file_pool/opensearch

# Remount everything
sudo zfs mount -a

zfs settings:
recordsize - The Block Size (16K is good for postgres, 1M to read large files)
compression - Compression Type (lz4 is extremely fast - CPU can compress data faster than nvme writing, also skip already compressed files)
atime - Access Time (off turn off linux record access time of a file - avoid tiny write for every read)
logbias - Write setting (latency - for postgres to prioritize speed of individual writes as database needs to know a write is safe before writing)
primarycache - Enable caching (all - both file and metadata; metadata - keep the index of files in RAM but not the actual file - for OpenSearch and MinIO as they already have their own caching system - avoid double caching
xattr - Extra info (sa - handle extra infos like permission, browsing more efficiently by storing them in the file header instead of separate file location; ZFS creates a hidden internal directory for every single file that has extra metadata (like permissions or SELinux labels)