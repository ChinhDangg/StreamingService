events {}

http {
    upstream minio {
        server minio:9000;
    }

    server {
        listen 80;

        # =====================================
        # üé¨ Transcoded video (RAM, from ffmpeg)
        # =====================================
        # Example URIs:
        # Handles /stream/<videoId>/partial/...
        location ~ ^/stream/([^/]+)/partial/(.*)$ {
            alias /chunks/$1/partial/$2;
            add_header X-Origin "RAM (ffmpeg)" always;
            add_header X-Debug-Path $request_filename always;
        }

        # üîπ Preview (10% trailer @ 360p)
        location ~ ^/stream/([^/]+)/preview/(.*)$ {
            alias /chunks/$1/preview/$2;
            add_header X-Origin "RAM (ffmpeg, preview)" always;
        }

        # =====================================
        # üñº Images directly from MinIO
        # =====================================
        # Client URL:  /images/minio/<bucket>/<object>?X-Amz-...
        # Proxies to:  http://minio:9000/<bucket>/<object>?X-Amz-...
        # =====================================
        # üéû Original / high-res video (MinIO)
        # =====================================
        # MinIO via Nginx (preserve signed URL)
        # Client URL:  /stream/minio/<bucket>/<object>?X-Amz-...
        # Proxies to:  http://minio:9000/<bucket>/<object>?X-Amz-...
        # strip /stream/minio/ and preserve the signed query string (X-Amz-*)
        location ^~ /stream/minio/ {
            # trailing slash here REPLACES the matched prefix with "/"
            proxy_pass http://minio/;

            # Host header must match what you presigned with
            # (use localhost:9000 if Spring Boot signed against http://localhost:9000)
            proxy_set_header Host localhost:9000;

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header X-Origin "MinIO";
        }

        # Use cached resized images
        location /cache/ {
            alias /chunks/image-cache/;
            autoindex off;
            add_header Cache-Control "public, max-age=3600";
        }

        # =====================================
        # üö´ Fallback / deny
        # =====================================
        location /stream/ {
            return 404;
        }

        # =====================================
        # üåê Spring Boot API
        # =====================================
        # If Spring Boot runs *outside* Docker on your host machine
        location /api/ {
            proxy_pass http://host.docker.internal:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /page/ {
            proxy_pass http://host.docker.internal:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # If you later add Spring Boot into docker-compose, switch to:
        # location /api/ {
        #     proxy_pass http://springboot:8080;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }
    }
}
